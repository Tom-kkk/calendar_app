# 技术实现细节文档

## 一、数据模型详细设计

### 1.1 CalendarEvent 完整模型

```dart
import 'package:hive/hive.dart';

part 'calendar_event.g.dart';

@HiveType(typeId: 0)
class CalendarEvent extends HiveObject {
  @HiveField(0)
  final String id;

  @HiveField(1)
  String title;

  @HiveField(2)
  String? description;

  @HiveField(3)
  DateTime start;

  @HiveField(4)
  DateTime end;

  @HiveField(5)
  String? location;

  @HiveField(6)
  int? colorHex;

  @HiveField(7)
  bool isAllDay;

  @HiveField(8)
  List<ReminderSetting> reminders;

  @HiveField(9)
  String? recurrenceRule; // RRULE格式，如 "FREQ=DAILY;INTERVAL=1"

  @HiveField(10)
  DateTime createdAt;

  @HiveField(11)
  DateTime updatedAt;

  CalendarEvent({
    required this.id,
    required this.title,
    this.description,
    required this.start,
    required this.end,
    this.location,
    this.colorHex,
    this.isAllDay = false,
    List<ReminderSetting>? reminders,
    this.recurrenceRule,
    DateTime? createdAt,
    DateTime? updatedAt,
  })  : reminders = reminders ?? [],
        createdAt = createdAt ?? DateTime.now(),
        updatedAt = updatedAt ?? DateTime.now();

  // 计算事件持续时间
  Duration get duration => end.difference(start);

  // 判断是否在同一天
  bool isOnDate(DateTime date) {
    final dateOnly = DateTime(date.year, date.month, date.day);
    final startOnly = DateTime(start.year, start.month, start.day);
    final endOnly = DateTime(end.year, end.month, end.day);
    return dateOnly.isAtSameMomentAs(startOnly) ||
        dateOnly.isAtSameMomentAs(endOnly) ||
        (dateOnly.isAfter(startOnly) && dateOnly.isBefore(endOnly));
  }
}
```

### 1.2 ReminderSetting 模型

```dart
@HiveType(typeId: 1)
class ReminderSetting extends HiveObject {
  @HiveField(0)
  final int minutesBefore; // 提前多少分钟提醒

  @HiveField(1)
  final ReminderType type;

  ReminderSetting({
    required this.minutesBefore,
    this.type = ReminderType.notification,
  });

  Duration get duration => Duration(minutes: minutesBefore);
}

@HiveType(typeId: 2)
enum ReminderType {
  @HiveField(0)
  notification,
  @HiveField(1)
  email,
}
```

---

## 二、存储服务实现

### 2.1 StorageService 完整实现

```dart
import 'package:hive_flutter/hive_flutter.dart';
import '../models/calendar_event.dart';

class StorageService {
  static Box<CalendarEvent>? _eventBox;
  static const String _eventBoxName = 'events';

  /// 初始化存储服务
  static Future<void> init() async {
    // 注册适配器（需要先运行代码生成）
    if (!Hive.isAdapterRegistered(0)) {
      Hive.registerAdapter(CalendarEventAdapter());
    }
    if (!Hive.isAdapterRegistered(1)) {
      Hive.registerAdapter(ReminderSettingAdapter());
    }
    if (!Hive.isAdapterRegistered(2)) {
      Hive.registerAdapter(ReminderTypeAdapter());
    }

    _eventBox = await Hive.openBox<CalendarEvent>(_eventBoxName);
  }

  /// 保存事件
  static Future<void> saveEvent(CalendarEvent event) async {
    event.updatedAt = DateTime.now();
    await _eventBox?.put(event.id, event);
  }

  /// 获取所有事件
  static List<CalendarEvent> getAllEvents() {
    return _eventBox?.values.toList() ?? [];
  }

  /// 根据ID获取事件
  static CalendarEvent? getEventById(String id) {
    return _eventBox?.get(id);
  }

  /// 获取指定日期的事件
  static List<CalendarEvent> getEventsForDate(DateTime date) {
    final allEvents = getAllEvents();
    return allEvents.where((event) => event.isOnDate(date)).toList();
  }

  /// 获取指定日期范围的事件
  static List<CalendarEvent> getEventsForRange(
    DateTime start,
    DateTime end,
  ) {
    final allEvents = getAllEvents();
    return allEvents.where((event) {
      return (event.start.isBefore(end) || event.start.isAtSameMomentAs(end)) &&
          (event.end.isAfter(start) || event.end.isAtSameMomentAs(start));
    }).toList();
  }

  /// 删除事件
  static Future<void> deleteEvent(String id) async {
    await _eventBox?.delete(id);
  }

  /// 删除所有事件
  static Future<void> deleteAllEvents() async {
    await _eventBox?.clear();
  }

  /// 关闭存储
  static Future<void> close() async {
    await _eventBox?.close();
  }
}
```

### 2.2 Hive适配器代码生成

在 `pubspec.yaml` 中添加开发依赖：
```yaml
dev_dependencies:
  hive_generator: ^2.0.0
  build_runner: ^2.4.0
```

运行代码生成：
```bash
flutter pub run build_runner build
```

---

## 三、通知服务实现

### 3.1 NotificationService 完整实现

```dart
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:timezone/timezone.dart' as tz;
import '../models/calendar_event.dart';
import '../models/reminder_setting.dart';

class NotificationService {
  static final FlutterLocalNotificationsPlugin _notifications =
      FlutterLocalNotificationsPlugin();

  /// 初始化通知服务
  static Future<void> init() async {
    const androidSettings = AndroidInitializationSettings('@mipmap/ic_launcher');
    const iosSettings = DarwinInitializationSettings(
      requestAlertPermission: true,
      requestBadgePermission: true,
      requestSoundPermission: true,
    );

    const initSettings = InitializationSettings(
      android: androidSettings,
      iOS: iosSettings,
    );

    await _notifications.initialize(
      initSettings,
      onDidReceiveNotificationResponse: _onNotificationTapped,
    );

    // 请求权限（Android 13+）
    await _requestPermissions();
  }

  /// 请求通知权限
  static Future<void> _requestPermissions() async {
    final androidPlugin = _notifications.resolvePlatformSpecificImplementation<
        AndroidFlutterLocalNotificationsPlugin>();
    await androidPlugin?.requestNotificationsPermission();
  }

  /// 通知点击回调
  static void _onNotificationTapped(NotificationResponse response) {
    // 处理通知点击事件
    print('通知被点击: ${response.payload}');
  }

  /// 为事件调度提醒
  static Future<void> scheduleReminders(CalendarEvent event) async {
    // 先取消该事件的所有旧提醒
    await cancelEventReminders(event.id);

    // 为每个提醒设置创建通知
    for (final reminder in event.reminders) {
      final reminderTime = event.start.subtract(reminder.duration);
      
      // 如果提醒时间已过，跳过
      if (reminderTime.isBefore(DateTime.now())) {
        continue;
      }

      final notificationId = _generateNotificationId(event.id, reminder);
      
      await _notifications.zonedSchedule(
        notificationId,
        event.title,
        event.description ?? '日程提醒',
        tz.TZDateTime.from(reminderTime, tz.local),
        const NotificationDetails(
          android: AndroidNotificationDetails(
            'calendar_reminders',
            '日程提醒',
            channelDescription: '日历应用的日程提醒通知',
            importance: Importance.high,
            priority: Priority.high,
          ),
          iOS: DarwinNotificationDetails(),
        ),
        androidScheduleMode: AndroidScheduleMode.exactAllowWhileIdle,
        uiLocalNotificationDateInterpretation:
            UILocalNotificationDateInterpretation.absoluteTime,
        payload: event.id,
      );
    }
  }

  /// 取消事件的所有提醒
  static Future<void> cancelEventReminders(String eventId) async {
    // 生成所有可能的通知ID并取消
    for (int i = 0; i < 100; i++) {
      await _notifications.cancel(_generateNotificationId(eventId, i));
    }
  }

  /// 生成通知ID
  static int _generateNotificationId(String eventId, dynamic reminder) {
    // 使用事件ID和提醒设置的哈希值生成唯一ID
    final hash = eventId.hashCode ^ reminder.hashCode;
    return hash.abs() % 2147483647; // 确保在int范围内
  }

  /// 取消所有通知
  static Future<void> cancelAllNotifications() async {
    await _notifications.cancelAll();
  }
}
```

---

## 四、日历视图实现细节

### 4.1 月视图实现（使用table_calendar）

```dart
import 'package:flutter/material.dart';
import 'package:table_calendar/table_calendar.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../state/calendar_state.dart';
import '../services/storage_service.dart';
import '../models/calendar_event.dart';

class MonthView extends ConsumerStatefulWidget {
  const MonthView({super.key});

  @override
  ConsumerState<MonthView> createState() => _MonthViewState();
}

class _MonthViewState extends ConsumerState<MonthView> {
  late DateTime _focusedDay;
  late DateTime _selectedDay;

  @override
  void initState() {
    super.initState();
    _focusedDay = DateTime.now();
    _selectedDay = DateTime.now();
  }

  @override
  Widget build(BuildContext context) {
    final calendarState = ref.watch(calendarProvider);
    final events = StorageService.getAllEvents();

    // 将事件按日期分组
    final eventMap = <DateTime, List<CalendarEvent>>{};
    for (final event in events) {
      final dateKey = DateTime(
        event.start.year,
        event.start.month,
        event.start.day,
      );
      eventMap[dateKey] = (eventMap[dateKey] ?? [])..add(event);
    }

    return Column(
      children: [
        TableCalendar<CalendarEvent>(
          firstDay: DateTime.utc(2020, 1, 1),
          lastDay: DateTime.utc(2030, 12, 31),
          focusedDay: _focusedDay,
          selectedDayPredicate: (day) => isSameDay(_selectedDay, day),
          eventLoader: (day) => eventMap[day] ?? [],
          startingDayOfWeek: StartingDayOfWeek.monday,
          calendarStyle: const CalendarStyle(
            todayDecoration: BoxDecoration(
              color: Colors.blue,
              shape: BoxShape.circle,
            ),
            selectedDecoration: BoxDecoration(
              color: Colors.blueAccent,
              shape: BoxShape.circle,
            ),
            markerDecoration: BoxDecoration(
              color: Colors.red,
              shape: BoxShape.circle,
            ),
          ),
          headerStyle: const HeaderStyle(
            formatButtonVisible: false,
            titleCentered: true,
          ),
          onDaySelected: (selectedDay, focusedDay) {
            setState(() {
              _selectedDay = selectedDay;
              _focusedDay = focusedDay;
            });
            ref.read(calendarProvider.notifier).selectDate(selectedDay);
          },
          onPageChanged: (focusedDay) {
            _focusedDay = focusedDay;
          },
        ),
        const SizedBox(height: 8),
        Expanded(
          child: _buildEventList(eventMap[_selectedDay] ?? []),
        ),
      ],
    );
  }

  Widget _buildEventList(List<CalendarEvent> events) {
    if (events.isEmpty) {
      return const Center(child: Text('这一天没有日程'));
    }

    return ListView.builder(
      itemCount: events.length,
      itemBuilder: (context, index) {
        final event = events[index];
        return ListTile(
          leading: CircleAvatar(
            backgroundColor: event.colorHex != null
                ? Color(event.colorHex!)
                : Colors.blue,
          ),
          title: Text(event.title),
          subtitle: Text(
            '${_formatTime(event.start)} - ${_formatTime(event.end)}',
          ),
          onTap: () {
            // 导航到事件详情页
          },
        );
      },
    );
  }

  String _formatTime(DateTime dateTime) {
    return '${dateTime.hour.toString().padLeft(2, '0')}:'
        '${dateTime.minute.toString().padLeft(2, '0')}';
  }
}
```

### 4.2 周视图实现

```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../state/calendar_state.dart';
import '../services/storage_service.dart';
import '../models/calendar_event.dart';

class WeekView extends ConsumerWidget {
  const WeekView({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final selectedDate = ref.watch(calendarProvider).selectedDate;
    final weekStart = _getWeekStart(selectedDate);
    final weekDays = List.generate(7, (i) => weekStart.add(Duration(days: i)));

    return Column(
      children: [
        // 周头部：显示日期
        _buildWeekHeader(weekDays),
        // 时间轴
        Expanded(child: _buildTimeAxis(weekDays)),
      ],
    );
  }

  DateTime _getWeekStart(DateTime date) {
    final weekday = date.weekday;
    return date.subtract(Duration(days: weekday - 1));
  }

  Widget _buildWeekHeader(List<DateTime> weekDays) {
    return Row(
      children: weekDays.map((day) {
        return Expanded(
          child: Column(
            children: [
              Text('周${_getWeekdayName(day.weekday)}'),
              Text('${day.day}'),
            ],
          ),
        );
      }).toList(),
    );
  }

  String _getWeekdayName(int weekday) {
    const names = ['一', '二', '三', '四', '五', '六', '日'];
    return names[weekday - 1];
  }

  Widget _buildTimeAxis(List<DateTime> weekDays) {
    final hours = List.generate(24, (i) => i);
    final allEvents = StorageService.getAllEvents();

    return ListView.builder(
      itemCount: hours.length,
      itemBuilder: (context, hourIndex) {
        final hour = hours[hourIndex];
        return SizedBox(
          height: 60,
          child: Row(
            children: [
              // 时间标签
              SizedBox(
                width: 60,
                child: Text('$hour:00'),
              ),
              // 每天的时间槽
              Expanded(
                child: Row(
                  children: weekDays.map((day) {
                    final dayEvents = allEvents.where((event) {
                      return event.isOnDate(day) &&
                          event.start.hour == hour;
                    }).toList();
                    return Expanded(
                      child: Container(
                        decoration: BoxDecoration(
                          border: Border.all(color: Colors.grey.shade300),
                        ),
                        child: _buildHourEvents(dayEvents),
                      ),
                    );
                  }).toList(),
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildHourEvents(List<CalendarEvent> events) {
    if (events.isEmpty) return const SizedBox();
    
    return Column(
      children: events.map((event) {
        return Container(
          margin: const EdgeInsets.all(2),
          padding: const EdgeInsets.all(4),
          decoration: BoxDecoration(
            color: event.colorHex != null
                ? Color(event.colorHex!)
                : Colors.blue,
            borderRadius: BorderRadius.circular(4),
          ),
          child: Text(
            event.title,
            style: const TextStyle(color: Colors.white, fontSize: 10),
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
          ),
        );
      }).toList(),
    );
  }
}
```

---

## 五、iCal导入导出实现

### 5.1 iCal导出服务

```dart
import 'dart:io';
import '../models/calendar_event.dart';

class ICalService {
  /// 导出事件为iCal格式
  static String exportToICal(List<CalendarEvent> events) {
    final buffer = StringBuffer();
    
    // iCal文件头
    buffer.writeln('BEGIN:VCALENDAR');
    buffer.writeln('VERSION:2.0');
    buffer.writeln('PRODID:-//Calendar App//EN');
    buffer.writeln('CALSCALE:GREGORIAN');
    buffer.writeln('METHOD:PUBLISH');

    // 导出每个事件
    for (final event in events) {
      buffer.writeln('BEGIN:VEVENT');
      buffer.writeln('UID:${event.id}');
      buffer.writeln('DTSTART:${_formatDateTime(event.start)}');
      buffer.writeln('DTEND:${_formatDateTime(event.end)}');
      buffer.writeln('SUMMARY:${_escapeText(event.title)}');
      if (event.description != null) {
        buffer.writeln('DESCRIPTION:${_escapeText(event.description!)}');
      }
      if (event.location != null) {
        buffer.writeln('LOCATION:${_escapeText(event.location!)}');
      }
      if (event.recurrenceRule != null) {
        buffer.writeln('RRULE:${event.recurrenceRule}');
      }
      // 提醒设置
      for (final reminder in event.reminders) {
        buffer.writeln('BEGIN:VALARM');
        buffer.writeln('TRIGGER:-PT${reminder.minutesBefore}M');
        buffer.writeln('ACTION:DISPLAY');
        buffer.writeln('DESCRIPTION:${_escapeText(event.title)}');
        buffer.writeln('END:VALARM');
      }
      buffer.writeln('END:VEVENT');
    }

    buffer.writeln('END:VCALENDAR');
    return buffer.toString();
  }

  /// 格式化日期时间为iCal格式
  static String _formatDateTime(DateTime dateTime) {
    return dateTime.toUtc().toIso8601String().replaceAll(RegExp(r'[-:]'), '').split('.')[0] + 'Z';
  }

  /// 转义文本（处理特殊字符）
  static String _escapeText(String text) {
    return text
        .replaceAll('\\', '\\\\')
        .replaceAll(',', '\\,')
        .replaceAll(';', '\\;')
        .replaceAll('\n', '\\n');
  }

  /// 保存为.ics文件
  static Future<File> saveToFile(String icalContent, String filePath) async {
    final file = File(filePath);
    await file.writeAsString(icalContent);
    return file;
  }
}
```

### 5.2 iCal导入服务

```dart
import 'dart:io';
import '../models/calendar_event.dart';
import '../models/reminder_setting.dart';

class ICalParser {
  /// 从.ics文件解析事件
  static Future<List<CalendarEvent>> parseFromFile(File file) async {
    final content = await file.readAsString();
    return parseFromString(content);
  }

  /// 从字符串解析iCal内容
  static List<CalendarEvent> parseFromString(String icalContent) {
    final events = <CalendarEvent>[];
    final lines = icalContent.split('\n');
    
    CalendarEvent? currentEvent;
    String? currentField;
    StringBuffer? currentValue;

    for (var line in lines) {
      line = line.trim();
      if (line.isEmpty) continue;

      if (line == 'BEGIN:VEVENT') {
        currentEvent = null;
        currentField = null;
        currentValue = null;
      } else if (line == 'END:VEVENT') {
        if (currentEvent != null) {
          events.add(currentEvent);
        }
      } else if (line.startsWith('UID:')) {
        final id = line.substring(4).trim();
        currentEvent = CalendarEvent(
          id: id,
          title: '',
          start: DateTime.now(),
          end: DateTime.now(),
        );
      } else if (line.startsWith('SUMMARY:')) {
        if (currentEvent != null) {
          currentEvent.title = _unescapeText(line.substring(8).trim());
        }
      } else if (line.startsWith('DTSTART:')) {
        if (currentEvent != null) {
          currentEvent.start = _parseDateTime(line.substring(8).trim());
        }
      } else if (line.startsWith('DTEND:')) {
        if (currentEvent != null) {
          currentEvent.end = _parseDateTime(line.substring(6).trim());
        }
      } else if (line.startsWith('DESCRIPTION:')) {
        if (currentEvent != null) {
          currentEvent.description = _unescapeText(line.substring(12).trim());
        }
      } else if (line.startsWith('LOCATION:')) {
        if (currentEvent != null) {
          currentEvent.location = _unescapeText(line.substring(9).trim());
        }
      }
      // ... 处理其他字段
    }

    return events;
  }

  /// 解析iCal日期时间格式
  static DateTime _parseDateTime(String dateTimeStr) {
    // 移除Z后缀并解析
    if (dateTimeStr.endsWith('Z')) {
      dateTimeStr = dateTimeStr.substring(0, dateTimeStr.length - 1);
      // 格式: YYYYMMDDTHHMMSS
      final year = int.parse(dateTimeStr.substring(0, 4));
      final month = int.parse(dateTimeStr.substring(4, 6));
      final day = int.parse(dateTimeStr.substring(6, 8));
      final hour = int.parse(dateTimeStr.substring(9, 11));
      final minute = int.parse(dateTimeStr.substring(11, 13));
      final second = dateTimeStr.length > 13
          ? int.parse(dateTimeStr.substring(13, 15))
          : 0;
      return DateTime.utc(year, month, day, hour, minute, second).toLocal();
    }
    // 处理本地时间格式
    return DateTime.now(); // 简化处理，实际需要完整解析
  }

  /// 反转义文本
  static String _unescapeText(String text) {
    return text
        .replaceAll('\\n', '\n')
        .replaceAll('\\;', ';')
        .replaceAll('\\,', ',')
        .replaceAll('\\\\', '\\');
  }
}
```

---

## 六、性能优化建议

### 6.1 事件查询优化

- 使用索引：为常用查询字段建立索引
- 缓存机制：缓存最近查询的结果
- 分页加载：大量事件时使用分页

### 6.2 UI渲染优化

- 使用`const`构造函数减少重建
- 使用`ListView.builder`而非`ListView`
- 避免在`build`方法中进行重计算

### 6.3 通知优化

- 批量调度通知
- 定期清理过期通知
- 使用精确通知（Android 12+）

---

**文档版本**: v1.0  
**最后更新**: 2025年1月

