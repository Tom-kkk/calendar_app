# 日历应用开发 - 需求与技术设计文档

## 一、项目概述

### 1.1 项目目标
开发一个符合RFC5545标准的日历应用，支持日程管理、提醒功能，并具备扩展能力。

### 1.2 技术选型
- **框架**: Flutter 3.9.2+ (跨平台开发)
- **状态管理**: Riverpod 2.5.1
- **本地存储**: Hive 2.2.3
- **日历组件**: table_calendar 3.2.0
- **通知**: flutter_local_notifications 19.5.0
- **时区处理**: timezone 0.10.1
- **国际化**: intl 0.20.2
- **UUID生成**: uuid 4.5.2

### 1.3 开发环境要求
- Flutter SDK 3.9.2 或更高版本
- Dart SDK 3.9.2 或更高版本
- Android Studio / VS Code
- Android SDK / Xcode (iOS开发)

---

## 二、需求分析

### 2.1 基本功能需求

#### 2.1.1 日历视图展示
- **月视图**: 显示整月日历，标注有事件的日期
- **周视图**: 显示一周7天的日程安排，支持时间轴展示
- **日视图**: 显示单日详细时间轴，精确到小时/分钟

#### 2.1.2 日程管理（CRUD）
- **添加**: 支持创建新日程，包含标题、时间、描述、提醒设置等
- **编辑**: 修改已有日程的所有属性
- **查看**: 点击日程查看详细信息
- **删除**: 支持删除单个或批量删除日程

#### 2.1.3 日程提醒功能
- 支持多种提醒时间（提前5分钟、15分钟、1小时、1天等）
- 本地通知提醒
- 提醒状态管理（已提醒/未提醒）

### 2.2 扩展功能需求

#### 2.2.1 日历事件导入导出
- **导出**: 支持导出为iCalendar格式(.ics文件)，符合RFC5545标准
- **导入**: 支持从.ics文件导入日程事件
- **分享**: 支持通过系统分享功能导出日程

#### 2.2.2 网络订阅功能
- 支持订阅远程日历（iCal URL）
- 定期同步远程日历事件
- 支持多个订阅源管理

#### 2.2.3 农历相关功能
- 显示农历日期
- 支持农历节日标注
- 农历与公历转换

---

## 三、技术架构设计

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                    Presentation Layer                    │
│  (UI Widgets: DayView, WeekView, MonthView, EventForm)  │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────┐
│                   State Management                       │
│              (Riverpod Providers)                        │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────┐
│                    Domain Layer                          │
│  (Models: CalendarEvent, CalendarState, Business Logic)  │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────┐
│                     Data Layer                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ Local Storage│  │ Notifications│  │  iCal Parser │  │
│  │    (Hive)    │  │   (Local)    │  │   (Export)   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 3.2 目录结构设计

```
lib/
├── main.dart                    # 应用入口
├── models/                      # 数据模型
│   ├── calendar_event.dart      # 日程事件模型
│   ├── calendar_state.dart      # 日历状态模型
│   └── reminder_settings.dart   # 提醒设置模型
├── providers/                   # Riverpod状态管理
│   ├── calendar_provider.dart   # 日历状态Provider
│   ├── event_provider.dart      # 事件管理Provider
│   └── notification_provider.dart # 通知Provider
├── services/                    # 业务服务层
│   ├── storage_service.dart     # 本地存储服务
│   ├── notification_service.dart # 通知服务
│   ├── ical_service.dart        # iCal导入导出服务
│   └── lunar_calendar_service.dart # 农历服务
├── views/                       # 视图层
│   ├── day_view.dart            # 日视图
│   ├── week_view.dart           # 周视图
│   ├── month_view.dart          # 月视图
│   ├── event_form_view.dart     # 事件编辑表单
│   └── event_detail_view.dart   # 事件详情页
├── widgets/                     # 可复用组件
│   ├── event_card.dart          # 事件卡片
│   ├── calendar_header.dart     # 日历头部
│   └── reminder_picker.dart     # 提醒选择器
└── utils/                       # 工具类
    ├── date_utils.dart          # 日期工具
    ├── ical_parser.dart         # iCal解析器
    └── constants.dart           # 常量定义
```

### 3.3 数据模型设计

#### CalendarEvent (日程事件)
```dart
class CalendarEvent {
  String id;                    // UUID
  String title;                 // 标题
  String? description;          // 描述
  DateTime start;              // 开始时间
  DateTime end;                // 结束时间
  String? location;            // 地点
  int? colorHex;               // 颜色标识
  List<ReminderSetting> reminders; // 提醒设置列表
  bool isAllDay;               // 是否全天事件
  String? recurrenceRule;       // 重复规则(RRULE)
  DateTime? createdAt;         // 创建时间
  DateTime? updatedAt;         // 更新时间
}
```

#### ReminderSetting (提醒设置)
```dart
class ReminderSetting {
  Duration beforeTime;          // 提前时间
  ReminderType type;           // 提醒类型(通知/邮件等)
}
```

### 3.4 状态管理设计

使用Riverpod进行状态管理，主要Provider：

1. **calendarProvider**: 管理当前选中的日期、视图类型
2. **eventsProvider**: 管理所有日程事件
3. **notificationProvider**: 管理通知相关状态

---

## 四、开发流程与实现计划

### 4.1 开发阶段划分

#### 阶段一：基础框架搭建（已完成）
- ✅ 项目初始化
- ✅ 依赖配置
- ✅ 基础状态管理框架
- ✅ 视图切换框架

#### 阶段二：核心功能实现

**2.1 日历视图实现**
- [ ] 月视图完整实现（使用table_calendar）
- [ ] 周视图实现（时间轴布局）
- [ ] 日视图实现（时间轴布局）
- [ ] 日期选择与导航功能

**2.2 日程管理功能**
- [ ] 事件数据模型完善
- [ ] 事件添加表单UI
- [ ] 事件编辑功能
- [ ] 事件详情查看
- [ ] 事件删除功能
- [ ] 事件持久化存储（Hive）

**2.3 提醒功能**
- [ ] 通知权限申请
- [ ] 通知服务初始化
- [ ] 提醒设置UI
- [ ] 提醒调度逻辑
- [ ] 通知触发处理

#### 阶段三：扩展功能实现

**3.1 iCal导入导出**
- [ ] iCal格式解析器
- [ ] 事件导出为.ics文件
- [ ] .ics文件导入解析
- [ ] 文件分享功能

**3.2 网络订阅**
- [ ] 网络请求服务
- [ ] 远程日历解析
- [ ] 订阅管理UI
- [ ] 定期同步机制

**3.3 农历功能**
- [ ] 农历计算库集成
- [ ] 农历显示组件
- [ ] 农历节日数据
- [ ] 公历农历转换

#### 阶段四：优化与测试
- [ ] UI/UX优化
- [ ] 性能优化
- [ ] 错误处理
- [ ] 单元测试
- [ ] 集成测试

---

## 五、关键技术实现方案

### 5.1 日历视图实现

#### 月视图
使用`table_calendar`库实现：
- 配置日历样式
- 事件标记显示
- 日期选择交互

#### 周视图/日视图
自定义时间轴组件：
- 24小时时间轴
- 事件块拖拽（可选）
- 时间选择器

### 5.2 数据持久化

使用Hive进行本地存储：
```dart
// 初始化Hive Box
await Hive.openBox<CalendarEvent>('events');

// 保存事件
box.put(event.id, event);

// 读取事件
final event = box.get(eventId);
```

### 5.3 通知实现

使用`flutter_local_notifications`：
```dart
// 初始化通知
await _notifications.initialize(...);

// 调度通知
await _notifications.zonedSchedule(
  id,
  title,
  body,
  scheduledDate,
  ...
);
```

### 5.4 iCal格式处理

RFC5545标准实现：
- 解析.ics文件格式
- 生成符合标准的.ics文件
- 处理VEVENT、VALARM等组件

### 5.5 农历计算

可选的实现方案：
- 使用第三方农历库（如`lunar`）
- 或实现农历转换算法

---

## 六、开发步骤详解（Flutter小白指南）

### 6.1 环境准备

1. **安装Flutter SDK**
   ```bash
   # 下载Flutter SDK并解压
   # 配置环境变量 PATH
   # 运行 flutter doctor 检查环境
   ```

2. **安装开发工具**
   - Android Studio（推荐）或 VS Code
   - 安装Flutter和Dart插件

3. **配置设备**
   - Android: 配置Android SDK，启动模拟器或连接真机
   - iOS: 需要Mac + Xcode（仅iOS开发需要）

### 6.2 项目运行

```bash
# 进入项目目录
cd calendar_app

# 获取依赖
flutter pub get

# 运行应用
flutter run
```

### 6.3 开发顺序建议

**第一步：完善数据模型**
- 扩展`CalendarEvent`类，添加所有必要字段
- 实现序列化/反序列化（用于Hive存储）

**第二步：实现存储服务**
- 创建`StorageService`类
- 实现事件的增删改查方法
- 测试数据持久化

**第三步：实现月视图**
- 使用`table_calendar`配置月视图
- 显示事件标记
- 实现日期选择

**第四步：实现事件表单**
- 创建事件添加/编辑页面
- 表单验证
- 保存到存储服务

**第五步：实现周视图和日视图**
- 自定义时间轴组件
- 显示事件列表
- 支持点击查看详情

**第六步：实现通知功能**
- 申请通知权限
- 实现通知服务
- 在事件保存时调度通知

**第七步：实现扩展功能**
- 按优先级实现扩展需求

### 6.4 常见问题解决

1. **依赖冲突**: 运行`flutter pub upgrade`更新依赖
2. **构建错误**: 运行`flutter clean`后重新构建
3. **通知不显示**: 检查权限和通知初始化代码

---

## 七、测试策略

### 7.1 单元测试
- 数据模型测试
- 业务逻辑测试
- 工具类测试

### 7.2 集成测试
- 事件CRUD流程测试
- 通知触发测试
- 数据持久化测试

### 7.3 UI测试
- 视图切换测试
- 表单交互测试

---

## 八、部署与发布

### 8.1 Android发布
```bash
# 构建APK
flutter build apk --release

# 构建App Bundle
flutter build appbundle --release
```

### 8.2 iOS发布
```bash
# 构建iOS应用
flutter build ios --release
```

---

## 九、参考资料

- [Flutter官方文档](https://flutter.dev/docs)
- [RFC5545标准](https://tools.ietf.org/html/rfc5545)
- [Riverpod文档](https://riverpod.dev/)
- [table_calendar文档](https://pub.dev/packages/table_calendar)
- [Hive文档](https://docs.hivedb.dev/)

---

## 十、项目时间规划

| 阶段 | 任务 | 预计时间 |
|------|------|----------|
| 阶段二 | 核心功能实现 | 2-3周 |
| 阶段三 | 扩展功能实现 | 1-2周 |
| 阶段四 | 优化与测试 | 1周 |
| **总计** | | **4-6周** |

---

## 十一、验收标准

### 基本要求验收
- [ ] 三种视图（月/周/日）正常显示和切换
- [ ] 可以添加、编辑、查看、删除日程
- [ ] 提醒功能正常工作，能收到通知

### 扩展要求验收
- [ ] 可以导出.ics文件
- [ ] 可以导入.ics文件
- [ ] 网络订阅功能正常（如实现）
- [ ] 农历显示正常（如实现）

---

**文档版本**: v1.0  
**最后更新**: 2025年1月  
**维护者**: 开发团队

